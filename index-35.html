<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ether Dome — Interactive Narrative</title>
  <style>
    * { box-sizing: border-box; }
    
    :root {
      --bg: #0e0c08;
      --parch: #f5edd8;
      --parch2: #e8d9bc;
      --gold: #8b6914;
      --fade: #6b5c3e;
      --card: rgba(15,12,8,0.74);
      --border: rgba(139,105,20,0.38);
      --text-speed: 1;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--parch);
      font-family: "IM Fell English", Georgia, serif;
      line-height: 1.6;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
      position: relative;
    }

    #domeBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("assets/img/dome.png");
      background-size: cover;
      background-position: center;
      opacity: 0.15;
      z-index: 0;
      pointer-events: none;
    }

    #topbar {
      width: 100%;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
      gap: 1rem;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls label {
      font-size: 0.75rem;
      letter-spacing: 0.04em;
      color: var(--gold);
      opacity: 0.8;
      white-space: nowrap;
    }

    #speedControl {
      width: 70px;
      cursor: pointer;
      accent-color: var(--gold);
    }

    button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--parch);
      font-family: "IM Fell English", serif;
      padding: 0.6rem 1rem;
      cursor: pointer;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    button:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    button.muted {
      opacity: 0.6;
    }

    #game {
      width: min(760px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.5rem;
      position: relative;
      z-index: 2;
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .location-tag {
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--fade);
      margin-bottom: 0.5rem;
    }

    h1 {
      font-family: "Playfair Display", serif;
      font-size: 1.8rem;
      margin: 0.5rem 0 1rem;
      color: var(--parch);
    }

    #portrait {
      display: block;
      width: min(520px, 90%);
      height: auto;
      margin: 1.15rem auto;
      border-radius: 10px;
      border: 1px solid rgba(245,237,216,0.10);
      box-shadow: 0 16px 35px rgba(0,0,0,0.32);
      max-height: 70vh;
      object-fit: contain;
      animation: portraitFade 0.6s ease-out;
    }

    @keyframes portraitFade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #text {
      font-size: 1.05rem;
      line-height: 1.65;
      color: var(--parch2);
      word-wrap: break-word;
      overflow-wrap: break-word;
      margin-bottom: 2rem;
    }

    .line {
      opacity: 0;
      transition: opacity calc(7500ms / var(--text-speed)) ease;
      display: inline;
    }

    .line.in {
      opacity: 1;
    }

    em {
      color: var(--parch);
      font-style: italic;
    }

    #choices {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(139,105,20,0.15);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 550ms ease, transform 550ms ease;
      clear: both;
    }

    #choices.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .choice-label {
      font-family: "Playfair Display", serif;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--fade);
      margin-bottom: 0.5rem;
      margin-top: 1rem;
    }

    #choiceButtons {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    button.choice {
      min-height: 3rem;
      display: flex;
      align-items: center;
      text-align: left;
      padding: 0.85rem 1.05rem;
    }

    button.choice:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.continue {
      width: 100%;
      margin-top: 1rem;
    }

    @media (max-width: 480px) {
      #game { padding: 1rem; }
      h1 { font-size: 1.4rem; }
      #text { font-size: 1rem; margin-bottom: 3rem; }
      #choices { margin-top: 4rem; padding-top: 2rem; }
      button.choice { font-size: 0.95rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div id="domeBackground"></div>

  <div id="topbar">
    <div class="controls">
      <label for="speedControl">Text Speed</label>
      <input type="range" id="speedControl" min="0.5" max="2" step="0.25" value="1" title="Adjust text reveal speed">
    </div>
    <button id="audioToggle" class="muted">♪ Ambience OFF</button>
  </div>

  <div id="game">
    <div class="location-tag" id="locationTag"></div>
    <h1 id="title"></h1>
    <img id="portrait" alt="" style="display:none;" />
    <div id="text"></div>
    <div id="choices">
      <div class="choice-label" id="choiceLabel"></div>
      <div id="choiceButtons"></div>
    </div>
  </div>

  <script>
    const State = {
      doctor: "none",
      drive: 0,
      fracture: 0
    };

    let audioEnabled = false;
    let audioReady = false;
    window.textSpeed = 1;

    const music = new Audio("assets/audio/main.mp3");
    const sting = new Audio("assets/audio/sting.mp3");
    music.loop = true;
    music.volume = 0.55;
    sting.volume = 0.75;

    function playAudio(audioEl) {
      if (!audioEl) return;
      try {
        audioEl.play().catch(() => {});
      } catch (e) {}
    }

    function startAudioOnce() {
      if (audioReady) return;
      audioReady = true;
      if (audioEnabled) playAudio(music);
    }

    ["pointerdown", "touchstart", "mousedown", "keydown"].forEach(ev => {
      document.addEventListener(ev, startAudioOnce, { once: true });
    });

    const elLocationTag = document.getElementById("locationTag");
    const elTitle = document.getElementById("title");
    const elText = document.getElementById("text");
    const elPortrait = document.getElementById("portrait");
    const elChoices = document.getElementById("choices");
    const elChoiceLabel = document.getElementById("choiceLabel");
    const elChoiceButtons = document.getElementById("choiceButtons");
    const audioBtn = document.getElementById("audioToggle");
    const speedControl = document.getElementById("speedControl");

    audioBtn.addEventListener("click", () => {
      audioEnabled = !audioEnabled;
      audioBtn.classList.toggle("muted", !audioEnabled);
      audioBtn.textContent = audioEnabled ? "♪ Ambience ON" : "♪ Ambience OFF";
      if (!audioEnabled) {
        music.pause();
      } else {
        startAudioOnce();
        playAudio(music);
      }
    });

    speedControl.addEventListener("input", (e) => {
      const speed = parseFloat(e.target.value);
      document.documentElement.style.setProperty("--text-speed", speed);
      window.textSpeed = speed;
    });

    function bump(which) {
      if (which === "drive") State.drive = Math.min(5, State.drive + 1);
      if (which === "fracture") State.fracture = Math.min(5, State.fracture + 1);
    }

    function hideChoices() {
      elChoices.classList.remove("visible");
      elChoiceButtons.innerHTML = "";
    }

    function revealHTML(el, html, done) {
      const parts = String(html).split(/<br\s*\/?>\s*<br\s*\/?>/i).map(s => s.trim()).filter(Boolean);
      el.innerHTML = "";
      let idx = 0;

      function addChunk() {
        const chunk = parts.slice(idx, idx + 2);
        idx += chunk.length;

        chunk.forEach(p => {
          const para = document.createElement("p");
          para.style.margin = "0 0 0.9rem 0";
          const lines = p.split(/<br\s*\/?>/i).map(line => line.trim()).filter(Boolean);

          lines.forEach((line, lineIdx) => {
            const lineSpan = document.createElement("span");
            lineSpan.className = "line";
            lineSpan.innerHTML = line;
            para.appendChild(lineSpan);
            if (lineIdx < lines.length - 1) para.appendChild(document.createElement("br"));

            const baseDelay = 7500;
            const delay = baseDelay / (window.textSpeed || 1);
            setTimeout(() => {
              requestAnimationFrame(() => lineSpan.classList.add("in"));
            }, lineIdx * delay);
          });

          el.appendChild(para);
        });

        if (idx < parts.length) {
          elChoiceButtons.innerHTML = "";
          const btn = document.createElement("button");
          btn.className = "continue";
          btn.textContent = "Continue";
          btn.onclick = addChunk;
          elChoiceButtons.appendChild(btn);
          elChoices.classList.add("visible");
        } else {
          if (typeof done === "function") done();
        }
      }

      addChunk();
    }

    function revealChoices(label, items) {
      elChoiceLabel.textContent = label || "";
      elChoiceButtons.innerHTML = "";

      items.forEach(c => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.innerHTML = c.text;
        btn.addEventListener("click", () => {
          btn.disabled = true;
          btn.style.opacity = "0.5";
          if (c.fx === "sting" && audioEnabled) playAudio(sting);
          c.onSelect && c.onSelect();
        });
        elChoiceButtons.appendChild(btn);
      });

      const delayMs = Math.max(5000, (window.textSpeed ? 5000 / window.textSpeed : 5000));
      setTimeout(() => {
        requestAnimationFrame(() => elChoices.classList.add("visible"));
      }, delayMs);
    }

    const passages = {
      start: {
        location: "Massachusetts General Hospital · Boston · October 16, 1846",
        title: "The Ether Dome",
        portrait: null,
        text: `The Ether Dome sits like a pale bowl turned upside down on the hospital roof, a chapel built for spectators. The benches are arranged in patient arcs so that nothing can be hidden—no tremor, no plea, no involuntary thrash of muscle as the blade insists. Boston's medical men gather with their students tucked close behind them, hungry to witness suffering because suffering has always been the proof that surgery is real. Pain is the sound that confirms a boundary has been crossed.<br><br>Today, that boundary is about to be negotiated chemically.<br><br>The air is warm with breath and wool. A faint sweetness threads through it—sharp, solvent, almost floral. No one names it with reverence yet. They have come to watch a demonstration. They do not understand they have come to watch the first public permission slip for disappearance.<br><br><em>You are the witness. Choose whose fate you will follow, and the Dome will obligingly reshape its story around your gaze.</em>`,
        choices: {
          label: "Whose story will you enter?",
          items: [
            { text: "William Morton — ambitious, late, reeking of orange oil", onSelect: () => go("morton-1") },
            { text: "Charles Jackson — the mind behind the idea, furious at erasure", onSelect: () => go("jackson-1") },
            { text: "Horace Wells — the pioneer the room once mocked", onSelect: () => go("wells-1") }
          ]
        }
      },

      "morton-1": {
        location: "The Ether Dome · Demonstration Day",
        title: "Morton's Entrance",
        portrait: "assets/img/morton.png",
        text: `Morton arrives late. He moves as if he has not noticed the laughter. His apparatus smells of orange—bright, domestic. The patient, Gilbert Abbott, shows his fear plainly.<br><br>Morton raises the inhaler. He has practiced this moment. He knows the room must feel inevitability.`,
        choices: {
          label: "Decision 1",
          items: [
            { text: "Proceed with theatrical certainty", onSelect: () => { bump("drive"); go("morton-2"); } },
            { text: "Slow down, adjust, insist on control", onSelect: () => { bump("fracture"); go("morton-3"); } }
          ]
        }
      },

      "morton-2": {
        location: "The Ether Dome · The First Silence",
        title: "No Humbug",
        portrait: "assets/img/morton.png",
        text: `You do not allow doubt to show. Abbott's eyes lose focus. Warren's scalpel descends. The silence that follows is heavy. It lands like a wet cloth. Then Warren speaks: <em>"Gentlemen, this is no humbug."</em> Applause arrives. It hits you in the chest like a drug.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Accept the miracle. It is yours.", onSelect: () => go("morton-end") },
            { text: "Let others claim the victory. Distance yourself.", onSelect: () => go("morton-end") }
          ]
        }
      },

      "morton-3": {
        location: "The Ether Dome · The Hesitation",
        title: "The Second Thoughts",
        portrait: "assets/img/morton.png",
        text: `You slow the apparatus. You adjust. You insist on control, on precision. Abbott's breathing steadies. When Warren's scalpel touches flesh, there is no scream. But your hands are trembling. The room notices.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Admit your fear. Let them see you.", onSelect: () => go("morton-end") },
            { text: "Hide it. Perform certainty you don't feel.", onSelect: () => go("morton-end") }
          ]
        }
      },

      "morton-end": {
        location: "Stockbridge, Massachusetts · Summer 1868",
        title: "The Quiet End",
        portrait: "assets/img/morton.png",
        text: `Twenty-two years later, you are in a garden. Someone asks you about that day. You tell them it was necessary. You do not tell them about the night sweats, the tremors in your hands, the recurring dream where the patient's eyes open mid-surgery. You die in this garden, on a bench, on a Tuesday. Your obituary mentions the Dome. You had hoped it might mention other things.`,
        choices: { label: "", items: [{ text: "Return to the Dome", onSelect: () => go("epilogue") }] }
      },

      "jackson-1": {
        location: "Balcony above the Ether Dome",
        title: "The Erasure",
        portrait: "assets/img/jackson.png",
        text: `You stand above, watching Morton receive the applause. The idea was yours. You published it first. You wrote the letters, performed the experiments, documented everything. And he receives the glory. This is how the world works.`,
        choices: {
          label: "Decision 1",
          items: [
            { text: "Let it go. Move forward.", onSelect: () => { bump("fracture"); go("jackson-2a"); } },
            { text: "Fight. Document everything. Demand credit.", onSelect: () => { bump("drive"); go("jackson-2b"); } }
          ]
        }
      },

      "jackson-2a": {
        location: "Boston · Autumn 1846",
        title: "The Retreat",
        portrait: "assets/img/jackson.png",
        text: `You write letters explaining your contribution. Most go unanswered. Some receive polite acknowledgments. None change the story. By 1848, you stop writing. By 1850, you stop opening replies. The wound hardens.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Surrender entirely. Build a different life.", onSelect: () => go("jackson-end") },
            { text: "Withdraw but keep the ledger. Keep score.", onSelect: () => go("jackson-end") }
          ]
        }
      },

      "jackson-2b": {
        location: "Medical Societies · 1847",
        title: "The Campaign",
        portrait: "assets/img/jackson.png",
        text: `You publish. You write. You petition the Massachusetts Medical Society. You build a case so meticulous, so correct, that it becomes impossible for anyone to read without understanding the injustice. And nothing changes.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Accept defeat.", onSelect: () => go("jackson-end") },
            { text: "Continue fighting until something breaks.", onSelect: () => go("jackson-end") }
          ]
        }
      },

      "jackson-end": {
        location: "McLean Hospital · May 28, 1873",
        title: "The Final Clinic",
        portrait: "assets/img/jackson.png",
        text: `You are admitted to McLean Hospital. The papers call it a nervous breakdown. You have spent twenty-seven years being right about something no one wanted to hear you be right about. In the hospital, you have access to chloroform. You use it less than you might. You are too disciplined for excess. But you dream of nothing while under its influence. You die here, in 1873, and your obituary mentions that you claimed to have discovered anesthesia. Most people assume this is the delusion of a madman.`,
        choices: { label: "", items: [{ text: "Return to the Dome", onSelect: () => go("epilogue") }] }
      },

      "wells-1": {
        location: "Standing in the crowd, unseen",
        title: "The Pioneer's Shadow",
        portrait: "assets/img/wells.png",
        text: `You discovered it first. Nitrous oxide. 1842. You demonstrated it on yourself, on volunteers. You knew it worked. But when you presented it to the medical establishment, they laughed at you. A dentist. A charlatan. You watched Morton's demonstration from the back. You watched them accept his ether because a man in fine clothes insisted on it with sufficient confidence.`,
        choices: {
          label: "Decision 1",
          items: [
            { text: "Accept obscurity. Move on.", onSelect: () => { bump("fracture"); go("wells-2a"); } },
            { text: "Make them see. Make them remember.", onSelect: () => { bump("drive"); go("wells-2b"); } }
          ]
        }
      },

      "wells-2a": {
        location: "Private practice · 1850s",
        title: "The Quiet Work",
        portrait: "assets/img/wells.png",
        text: `You go back to your dental practice. You use nitrous oxide on your patients. It works. They are grateful. Your life is small and decent and largely invisible. The world credits Morton. You know better.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Continue quietly.", onSelect: () => go("wells-end") },
            { text: "Document your work. Create a record.", onSelect: () => go("wells-end") }
          ]
        }
      },

      "wells-2b": {
        location: "Lecture halls and societies · 1850s",
        title: "The Public Campaign",
        portrait: "assets/img/wells.png",
        text: `You attempt to reclaim what was taken. You give lectures. You write letters. You remind anyone who will listen that you were first. The medical societies acknowledge this. They offer you credit. They call you a co-discoverer. This is meant to be generous. It feels like erasure with a smile.`,
        choices: {
          label: "Decision 2",
          items: [
            { text: "Accept the partial credit.", onSelect: () => go("wells-end") },
            { text: "Reject it entirely. All or nothing.", onSelect: () => go("wells-end") }
          ]
        }
      },

      "wells-end": {
        location: "A jail cell · New York · January 24, 1848",
        title: "The Rehearsal",
        portrait: "assets/img/wells.png",
        text: `Under chloroform, you do something described later as madness. Acid thrown at strangers. A face ruined. An arrest. You understand what the Dome taught humanity: consciousness can be suspended voluntarily. You have been practicing that step. Each use of gas, each moment of numbness, was a rehearsal.`,
        choices: { label: "", items: [{ text: "Return to the Dome", onSelect: () => go("epilogue") }] }
      },

      epilogue: {
        location: "The Ether Dome · After",
        title: "The Architecture of Silence",
        portrait: "assets/img/dome.png",
        text: `The Ether Dome empties. Boots descend the stairs. Coats sweep the air clean. The chair remains. The architecture remains. The room holds the faint sweetness of ether as though it has soaked into plaster.<br><br>The first time a body chose unconsciousness in the name of mercy, humanity discovered something that extends far beyond surgery: consciousness can be suspended voluntarily. Pain was not defeated; it was bypassed. The self was not destroyed; it was set aside.<br><br>The demonstration became a triumph. The triumph became a tool. The tool became a habit. And the habit outlived the men who fought to own it.<br><br><em>The door opened in this room did not close when the surgery ended. It never has.</em>`,
        choices: { label: "", items: [{ text: "↩ Begin Again", onSelect: () => go("start") }] }
      }
    };

    function go(key) {
      const p = passages[key];
      if (!p) return;
      hideChoices();
      elLocationTag.textContent = p.location || "";
      elTitle.textContent = p.title || "";
      if (p.portrait) {
        elPortrait.src = p.portrait;
        elPortrait.style.display = "block";
      } else {
        elPortrait.style.display = "none";
      }
      const html = typeof p.text === "function" ? p.text() : p.text;
      const ch = p.choices || { label: "", items: [] };
      revealHTML(elText, html || "", () => {
        const delayMs = Math.max(5000, (window.textSpeed ? 5000 / window.textSpeed : 5000));
        setTimeout(() => revealChoices(ch.label || "", ch.items || []), delayMs);
      });
    }

    go("start");
  </script>
</body>
</html>
