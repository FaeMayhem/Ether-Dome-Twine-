<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>The Ether Dome — A Tale of Three Fates</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0c08;
    --parch:#f5edd8;
    --parch2:#e8d9bc;
    --gold:#8b6914;
    --fade:#6b5c3e;
    --card:rgba(15,12,8,0.74);
    --border:rgba(139,105,20,0.38);
    --wash-blue: rgba(70,120,150,0.12);
    --wash-amber: rgba(160,115,35,0.12);
    --wash-ash: rgba(190,190,190,0.10);
    --text-speed: 1;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html {
    overflow-y: scroll;
  }
  body{
    background: var(--bg);
    color: var(--parch);
    font-family: "IM Fell English", serif;
    min-height: 100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding: 1.25rem 1rem 3.5rem;
    overflow-x:hidden;
  }
  body:before{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    opacity:0.045;
    z-index:0;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }
  .vignette{
    position:fixed; inset:0;
    pointer-events:none;
    z-index:1;
    background: radial-gradient(ellipse at center, transparent 48%, rgba(0,0,0,0.75) 100%);
    opacity:0.95;
  }
  .dome-bleed{
    display: block;
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at center, transparent, #000);
    pointer-events: none;
    z-index: 3;
    opacity: 0;
    transition: opacity 1s ease;
  }
  #topbar{
    position:fixed;
    top: 0.85rem;
    left: 0.85rem;
    right: auto;
    z-index: 50;
    display:flex;
    gap:1rem;
    align-items:center;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  #topbar > div {
    display:flex;
    gap:0.5rem;
    align-items:center;
  }
  #topbar label {
    font-size:0.75rem;
    color:var(--gold);
    opacity:0.8;
    white-space:nowrap;
  }
  #speedControl {
    width:70px;
    accent-color:var(--gold);
    cursor:pointer;
  }
  .btn-small{
    background: transparent;
    border: 1px solid var(--border);
    color: var(--gold);
    font-family: "IM Fell English", serif;
    padding: 0.35rem 0.65rem;
    font-size: 0.78rem;
    cursor:pointer;
    letter-spacing:0.04em;
    transition: all 0.2s ease;
  }
  .btn-small:hover{ background: rgba(139,105,20,0.10); border-color: rgba(139,105,20,0.7); }
  .btn-small.muted{ opacity:0.45; }
  
  #game{
    width: min(760px, 100%);
    position:relative;
    z-index:2;
    margin-top: 3.1rem;
    display: flex;
    justify-content: center;
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(139,105,20,0.28);
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    border-radius: 14px;
    padding: 1.15rem 1.05rem;
    backdrop-filter: blur(1px);
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow: visible;
    min-width: 0;
  }

  .location-tag{
    font-family: "Playfair Display", serif;
    font-size: 0.68rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: var(--gold);
    opacity: 0.92;
    margin-bottom: 1.1rem;
  }
  h1{
    font-family: "Playfair Display", serif;
    font-weight: 400;
    font-style: italic;
    line-height: 1.15;
    margin-bottom: 0.85rem;
    font-size: 1.75rem;
  }
  .portrait{
    display:block;
    width: 100%;
    max-width: 500px;
    height:auto;
    margin: 1.15rem 0 1.1rem 0;
    border-radius: 10px;
    box-shadow: 0 16px 35px rgba(0,0,0,0.32);
    border: 1px solid rgba(245,237,216,0.10);
    max-height: 60vh;
    object-fit: contain;
  }
  .wash{ position:relative; }
  .wash:after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 16px;
    pointer-events:none;
    opacity: 0;
    transition: opacity 600ms ease;
    background: var(--wash, transparent);
    mix-blend-mode: screen;
  }
  .wash.wash-on:after{ opacity: 1; }
  .narrator{
    font-size: 1.05rem;
    line-height: 1.86;
    color: var(--parch2);
    text-align: left;
    width: 100%;
    min-width: 0;
    max-width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  .narrator em{ color: var(--parch); }
  .narrator .grim{ color:#c49a9a; font-style: italic; }
  .choices{
    margin-top: 1.35rem;
    display:flex;
    flex-direction:column;
    gap: 0.65rem;
    width: 100%;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 550ms ease, transform 550ms ease;
  }
  .choices.visible{ opacity: 1; transform: translateY(0); }
  .choice-label{
    font-family:"Playfair Display", serif;
    font-size: 0.65rem;
    letter-spacing:0.2em;
    text-transform:uppercase;
    color: var(--fade);
    margin-top: 0.5rem;
    margin-bottom: 0.2rem;
  }
  button.choice{
    background: transparent;
    border: 1px solid var(--border);
    color: var(--parch);
    font-family:"IM Fell English", serif;
    font-size: 0.98rem;
    padding: 0.85rem 1.05rem;
    text-align:left;
    cursor:pointer;
    line-height:1.45;
    border-radius: 12px;
    transition: border-color 0.2s ease, background 0.2s ease, transform 0.08s ease;
    position:relative;
    overflow:hidden;
  }
  button.choice:hover{ border-color: rgba(139,105,20,0.78); background: rgba(139,105,20,0.07); }
  button.choice:active{ transform: translateY(1px); }
  button.choice:before{
    content:"❧";
    color: var(--gold);
    margin-right: 0.55rem;
    opacity: 0;
    transition: opacity 0.18s ease;
  }
  button.choice:hover:before{ opacity: 1; }
  #choiceButtons{
    display:flex;
    flex-direction:column;
    gap:0.65rem;
    width:100%;
  }

  .hud{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display:flex;
    justify-content: center;
    align-items:flex-start;
    gap: 1.5rem;
    padding: 0.55rem 1rem;
    border-top: 1px solid rgba(139,105,20,0.3);
    background: rgba(14,12,8,0.94);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    width: 100%;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 650ms ease, transform 650ms ease;
    z-index: 45;
  }
  .hud.visible{ opacity: 1; transform: translateY(0); }
  .meter{ flex:1; }
  .meter .label{
    font-family:"Playfair Display", serif;
    font-size: 0.68rem;
    letter-spacing:0.18em;
    text-transform:uppercase;
    color: var(--gold);
    opacity:0.9;
    margin-bottom: 0.4rem;
    white-space: nowrap;
    text-align: left;
  }
  .bars{ display:flex; gap:6px; flex-wrap:nowrap; }
  .bar{
    width: 18px; height: 8px;
    border-radius: 999px;
    border: 1px solid rgba(139,105,20,0.35);
    background: rgba(139,105,20,0.12);
    transition: background 320ms ease, border-color 320ms ease;
  }
  .bar.filled{ background: rgba(139,105,20,0.85); border-color: rgba(139,105,20,0.9); }

  @media (max-width: 420px){
    h1{font-size:1.55rem}
    .narrator{font-size:1.01rem}
    .bar{width:16px}
  }
  @media (prefers-reduced-motion: reduce){
    .choices, .hud, .dome-bleed{ transition:none !important; }
  }

</style>
</head>
<body>
<div class="dome-bleed" id="domeBleed"></div>
<div class="vignette"></div>

<div id="topbar">
  <div>
    <label for="speedControl">Text Speed</label>
    <input type="range" id="speedControl" min="0.5" max="2" step="0.25" value="1">
  </div>
  <button id="audioToggle" class="btn-small">♪ Ambience ON</button>
</div>

<div id="hud" class="hud" aria-live="polite">
  <div class="meter">
    <div class="label" id="driveLabel">Drive</div>
    <div class="bars" id="driveBars"></div>
  </div>
  <div class="meter">
    <div class="label" id="fractureLabel">Fracture</div>
    <div class="bars" id="fractureBars"></div>
  </div>
</div>

<div id="game" class="card wash">

  <div class="location-tag" id="locationTag"></div>
  <h1 id="title"></h1>

  <img id="portrait" class="portrait" alt="" style="display:none;" onerror="this.style.display='none';" />

  <div id="text" class="narrator" data-typewrite></div>

  <button id="skipBtn" class="btn-small" style="display:none; margin-top:0.6rem; align-self:flex-end;" onclick="skipFade()">Skip ▸</button>

  <div id="choices" class="choices">
    <div class="choice-label" id="choiceLabel"></div>
    <div id="choiceButtons"></div>
  </div>
</div>

<script>
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

const State = {
  doctor:"none",
  drive:0,
  fracture:0,
  meterShown:false,
  labels:{drive:"Drive", fracture:"Fracture"},
  completed:[]
};

function resetState(){
  const saved = State.completed || [];
  State.doctor="none";
  State.drive=0;
  State.fracture=0;
  State.meterShown=false;
  State.labels={drive:"Drive", fracture:"Fracture"};
  State.completed = saved;
  setWash(null);
  setDomeBleed(0);
  hideHUD();
}

let audioEnabled=true;
let music = new Audio("assets/audio/main.mp3");
let sting = new Audio("assets/audio/sting.mp3");
music.loop=true;
music.volume=0.55;
sting.volume=0.75;

const audioBtn=document.getElementById("audioToggle");
audioBtn.addEventListener("click",()=>{
  audioEnabled=!audioEnabled;
  audioBtn.classList.toggle("muted",!audioEnabled);
  audioBtn.textContent = audioEnabled ? "♪ Ambience ON" : "♪ Ambience OFF";
  if(!audioEnabled){ music.pause(); }
  else { music.play().catch(()=>{}); }
});

const speedControl = document.getElementById("speedControl");
if(speedControl) {
  speedControl.addEventListener("input", (e) => {
    const speed = parseFloat(e.target.value);
    document.documentElement.style.setProperty("--text-speed", speed);
    window.textSpeed = speed;
  });
  window.textSpeed = 1;
}

const elLocation=document.getElementById("locationTag");
const elTitle=document.getElementById("title");
const elText=document.getElementById("text");
const elChoices=document.getElementById("choices");
const elChoiceLabel=document.getElementById("choiceLabel");
const elChoiceButtons=document.getElementById("choiceButtons");
const elPortrait=document.getElementById("portrait");
const elHUD=document.getElementById("hud");
const elDriveLabel=document.getElementById("driveLabel");
const elFractureLabel=document.getElementById("fractureLabel");
const elDriveBars=document.getElementById("driveBars");
const elFractureBars=document.getElementById("fractureBars");
const domeBleed=document.getElementById("domeBleed");
const gameCard=document.getElementById("game");
const elSkip=document.getElementById("skipBtn");

function setWash(wash){
  gameCard.style.setProperty("--wash", wash || "transparent");
  gameCard.classList.toggle("wash-on", !!wash);
}
function setDomeBleed(opacity){
  domeBleed.style.opacity = String(clamp(opacity,0,0.92));
}
function showHUD(){
  if(State.meterShown) return;
  State.meterShown=true;
  elHUD.classList.add("visible");
}
function hideHUD(){ elHUD.classList.remove("visible"); }

function buildBars(container,value){
  container.innerHTML="";
  for(let i=0;i<5;i++){
    const b=document.createElement("div");
    b.className="bar"+(i<value?" filled":"");
    container.appendChild(b);
  }
}
function updateMeters(){
  elDriveLabel.textContent=State.labels.drive;
  elFractureLabel.textContent=State.labels.fracture;
  buildBars(elDriveBars, State.drive);
  buildBars(elFractureBars, State.fracture);
}

/* visual-line fade-in — detects actual line wraps on screen */
let fadeTimeouts=[];
let currentFadeCallback=null;
function clearFade(){ fadeTimeouts.forEach(t=>clearTimeout(t)); fadeTimeouts=[]; }

function getVisualLines(container){
  // Render all text invisibly, then measure which words fall on which visual line
  const words = [];
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
  let node;
  while((node = walker.nextNode())){
    const text = node.textContent;
    const parts = text.split(/(\s+)/);
    parts.forEach(part => {
      if(part.length === 0) return;
      const span = document.createElement("span");
      span.textContent = part;
      node.parentNode.insertBefore(span, node);
      words.push(span);
    });
    node.parentNode.removeChild(node);
  }
  // Group by vertical position (same offsetTop = same visual line)
  const lineMap = new Map();
  words.forEach(span => {
    const top = Math.round(span.offsetTop);
    if(!lineMap.has(top)) lineMap.set(top, []);
    lineMap.get(top).push(span);
  });
  // Sort by vertical position and return groups
  const sorted = [...lineMap.entries()].sort((a,b) => a[0] - b[0]);
  return sorted.map(([top, spans]) => spans);
}

function fadeInLines(targetEl, html, onComplete){
  clearFade();
  currentFadeCallback = onComplete;
  targetEl.innerHTML = "";

  // Normalize newlines to <br><br> for paragraph breaks
  let normalized = html.replace(/\n\s*\n/g, '<br><br>').replace(/\n/g, '<br><br>');

  // Split into paragraphs
  const paras = normalized.split(/<br\s*\/?>\s*<br\s*\/?>/gi).filter(c => c.trim());

  // Build paragraph elements, initially visible so we can measure
  const pEls = [];
  paras.forEach(paraHTML => {
    const p = document.createElement("p");
    p.innerHTML = paraHTML.trim();
    p.style.marginBottom = "0.85em";
    targetEl.appendChild(p);
    pEls.push(p);
  });

  // Measure visual lines across all paragraphs
  const allLineGroups = [];
  pEls.forEach(p => {
    const lines = getVisualLines(p);
    lines.forEach(group => allLineGroups.push(group));
  });

  // Now hide all word spans
  allLineGroups.forEach(group => {
    group.forEach(span => {
      span.style.opacity = "0";
      span.style.transition = "opacity 700ms ease";
    });
  });

  // Fade in line by line
  const speed = window.textSpeed || 1;
  const perLine = 1000 / speed;
  const baseDelay = 400 / speed;

  allLineGroups.forEach((group, i) => {
    const t = setTimeout(() => {
      group.forEach(span => { span.style.opacity = "1"; });
      // Auto-scroll to keep latest line visible
      const last = group[group.length - 1];
      if(last) last.scrollIntoView({behavior:"smooth", block:"nearest"});
    }, baseDelay + i * perLine);
    fadeTimeouts.push(t);
  });

  const totalTime = baseDelay + allLineGroups.length * perLine;
  const doneTimeout = setTimeout(() => {
    currentFadeCallback = null;
    onComplete && onComplete();
  }, totalTime + 500);
  fadeTimeouts.push(doneTimeout);
}

function skipFade(){
  clearFade();
  const spans = elText.querySelectorAll("span");
  spans.forEach(s => {
    s.style.transition = "none";
    s.style.opacity = "1";
  });
  elSkip.style.display = "none";
  if(currentFadeCallback) { const cb = currentFadeCallback; currentFadeCallback = null; cb(); }
}

function revealChoices(label, items){
  elChoiceLabel.textContent=label||"";
  elChoiceButtons.innerHTML="";
  items.forEach(c=>{
    const btn=document.createElement("button");
    btn.className="choice";
    btn.innerHTML=c.text;
    btn.addEventListener("click",()=>{
      if(c.fx==="sting" && audioEnabled){
        sting.currentTime=0;
        sting.play().catch(()=>{});
      }
      c.onSelect && c.onSelect();
    });
    elChoiceButtons.appendChild(btn);
  });
  requestAnimationFrame(()=> elChoices.classList.add("visible"));
}
function hideChoices(){
  elChoices.classList.remove("visible");
  elChoiceButtons.innerHTML="";
}

function endingToneSentence(doc){
  const d=State.drive, f=State.fracture;
  if(d===f) return "";
  const frac=f>d;
  if(doc==="morton") return frac
    ? "By the end, every headline reads like an accusation, every compliment like a theft."
    : "He carries his triumph like a crown, even as it cuts into him.";
  if(doc==="jackson") return frac
    ? "The more he tries to prove the truth, the more the truth becomes a tunnel with no exit."
    : "He keeps returning to the same claim, convinced that persistence will become proof.";
  if(doc==="wells") return frac
    ? "He does not fear pain nearly as much as he fears being forced to feel himself."
    : "He still reaches for vindication, even as the door to absence stands open.";
  return "";
}
function remainLine(doc){
  if(doc==="morton") return "No one is there to witness him as he fades to black one last time.";
  if(doc==="jackson") return "The argument continues, but only inside a skull that can no longer voice it.";
  if(doc==="wells") return "The silence arrives exactly as promised.";
  return "";
}
function escapeHTML(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function bump(which){
  if(which==="drive") State.drive=clamp(State.drive+1,0,5);
  if(which==="fracture") State.fracture=clamp(State.fracture+1,0,5);
  updateMeters();
  if(State.doctor==="wells"){
    setDomeBleed(0.06 + (State.fracture/5)*0.20);
  }
}

function goRemain(doc){
  if(!State.completed.includes(doc)) State.completed.push(doc);
  if(audioEnabled){
    music.volume=0.25;
    setTimeout(()=>{ music.volume=0.55; }, 1800);
  }
  setDomeBleed(0);
  render({
    location:"After",
    title:"Remain",
    portrait: (doc==="morton")?"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true":(doc==="jackson")?"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true":(doc==="wells")?"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true":null,
    wash: (doc==="morton")?"var(--wash-amber)":(doc==="jackson")?"var(--wash-blue)":(doc==="wells")?"var(--wash-ash)":null,
    text:`<em>${escapeHTML(remainLine(doc))}</em>`,
    choices:{ label:"", items:[{text:"↩ Return to the Dome — Begin Again", onSelect:()=>boot()}] }
  });
}

function enterDoctor(doc){
  resetState();
  State.doctor=doc;
  State.drive=2;
  State.fracture=2;
  State.meterShown=false;
  hideHUD();

  if(doc==="morton"){
    State.labels={drive:"Ambition", fracture:"Paranoia"};
    setWash("var(--wash-amber)");
    go("morton-1");
  } else if(doc==="jackson"){
    State.labels={drive:"Recognition", fracture:"Obsession"};
    setWash("var(--wash-blue)");
    go("jackson-1");
  } else if(doc==="wells"){
    State.labels={drive:"Redemption", fracture:"Dissolution"};
    setWash("var(--wash-ash)");
    go("wells-1");
  }
  updateMeters();
  if(audioEnabled){ music.play().catch(()=>{}); }
}

const passages={
  start:{
    location:"Massachusetts General Hospital · Boston · October 16, 1846",
    title:"The Ether Dome",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/dome.png?raw=true",
    wash:null,
    text:`The Ether Dome, open and airy, is above you, the bowl of the dome itself echoing back a lecturer's voice for the benefit of the students. The benches are spanned out in an arc, each row a step higher than the last so that no one will miss what transpires before - no tremor, no plea, no involuntary thrash of a spasming limb as the blade does its work. Boston's medical men gather here with their students in their seats above, leaving in. They are hungry to witness the promise of a new innovation, one that promises to ease suffering. The boundaries they work with are thin and difficult; suffering seems impossible to stave off. 
Today, that boundary is about to be redefined, chemically.
The air is cool. A faint sweetness threads through it—sharp, solvent, almost floral. They have come to watch a demonstration. Gilbert Abbott is seated before the gathered physicians a large tumor distorting his neck. This might be his last night if the surgery goes wrong.
You are here to witness this surgery perhaps, not you may choose to follow other players in this saga as well, those outside of The Dome who had a part in the history of anaesthesia in Boston. Choose whose fate you will follow, and the Dome will obligingly reshape its story around your gaze.`,
    choices:{ label:"Whose story will you enter?", items:[
      {text:"William Morton — ambitious, late, reeking of orange oil", onSelect:()=>enterDoctor("morton")},
      {text:"Charles Jackson — the mind behind the idea, furious at erasure", onSelect:()=>enterDoctor("jackson")},
      {text:"Horace Wells — the pioneer the room once mocked", onSelect:()=>enterDoctor("wells")}
    ]}
  },

  "morton-1":{
    location:"The Ether Dome · Demonstration Day",
    title:"Morton's Grand Entrance",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true",
    wash:"var(--wash-amber)",
    text:`Morton arrives late, a derisive murmur spreading through the class, eager to mock this seemingly ill-prepared man. He moves with determination, as if he has not noticed the laughter. He does not apologize. He is not the kind of man who apologized; he is made of sterner stock than that.
His apparatus smells faintly of orange…a bright scent, domestic and absurdly pleasant for a room built to carve into the flesh of the unwell. The patient, Gilbert Abbott, is young enough that the shape of his fear reads plainly on his face a mere 21 years. Straps hold him still in a chair that has seen too many tremble - a place of salvation…or death.
Morton raises the mouthpiece of the apparatus to Gilbert's face. He has practiced this, not only in the private sense of repetition but in the psychological sense of staging. He knows the room must feel the inevitability of this. He knows the men above him must lean forward to see for themselves before they can be converted as believers. He knows that if he can turn pain into peace in front of them, he will never again be only a dentist with a scheme.
The valve is adjusted, air is mixed with the solvent gas. Abbott breathes in. The diethyl ether, a sweet and burning solvent that vaporized at room temperature and was known as “sweet oil of vitreol,” coils into his lungs.`,
    choices:{ label:"Decision 1", items:[
      {text:"Proceed with theatrical certainty", onSelect:()=>{bump("drive"); showHUD(); go("morton-2a");}},
      {text:"Slow down, adjust, insist on control", onSelect:()=>{bump("fracture"); showHUD(); go("morton-2b");}}
    ]}
  },
  "morton-2a":{
    location:"The Ether Dome · The First Silence",
    title:"No Humbug",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true",
    wash:"var(--wash-amber)",
    text:`You do not allow your doubt to show. Doubt is contagious. You let the room see your confidence the way a gambler lets the table see a calm hand. Abbott's breathing changes. His eyes lose focus. There is a moment, thin, almost invisible…when the body decides whether it will fight. You press through that moment knowing your destiny awaits. Gilbert settles, still at last.
Dr. Warren's scalpel descends. Flesh yields. The room expects the eruption of resistance from the patient, the familiar animal protest of a life fighting for its own survival.
No scream comes.
The silence that replaces it is not empty. It is heavy, tense. For one terrifying second the crowd doesn't know how to react, because the script they have rehearsed for years has been broken. They remain rapt throughout the surgery, holding their breath in expectation.
It is done. The final stitches are in place. He is whole once more, his tumor on the table nearby.
Warren speaks, and his words ring like a gavel: "Gentlemen, this…is no humbug."
Applause arrives late, staggered and stunned. When it comes, it hits Morton in the chest like a drug. He tells himself this is about mercy, about the humane transformation of surgery, about civilization stepping forward. But beneath that polished narrative is a quieter truth he does not examine too closely: relief is noble…but, immortality is better. If the easement of pain is the key to his remembrance, then let that pain be silenced.`,
    choices:{ label:"Decision 2", items:[
      {text:"Claim the miracle as yours, publicly and permanently", onSelect:()=>{bump("drive"); go("morton-3");}},
      {text:"Credit ‘science’ and let the room assume the rest", onSelect:()=>{bump("fracture"); go("morton-3");}}
    ]}
  },
  "morton-2b":{
    location:"The Ether Dome · The First Silence",
    title:"Controlled Breath",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true",
    wash:"var(--wash-amber)",
    text:`You slow your actions. You check the seal, the solvent, the valve. You can feel the room's impatience sharpening into contempt. They want spectacle, but you want certainty. There is a particular terror in being wrong in public, and you have built your entire life around outrunning it.
Abbott breathes in. His chest rises. His fingers twitch once, involuntarily, a small rebellion that makes your throat go dry. You correct course, adjust pressure, wait for the body to surrender rather than forcing it to.
The blade descends. The expected scream doesn't arrive, but the room doesn't celebrate immediately. They watch like wolves deciding if the prey is truly dead.
Warren speaks the words anyway. The applause comes. It is thinner than it could have been, but it is real. Morton tells himself this is about mercy, about the humane transformation of surgery, about civilization stepping forward. But beneath that polished narrative is a quieter truth he does not examine too closely: relief is noble, but immortality is better.
And now that the room has seen this merciful oblivion, Morton realizes the most dangerous part is not the surgery but the claim that will follow. Credit can be stolen. His place in history can be stolen. He feels competitors materializing around the edges of the Dome like figures in fog.`,
    choices:{ label:"Decision 2", items:[
      {text:"Patent it. Rename it. Make ownership undeniable", onSelect:()=>{bump("drive"); go("morton-3");}},
      {text:"Go to Congress for recognition—force the nation to pay attention", onSelect:()=>{bump("fracture"); go("morton-3");}}
    ]}
  },
  "morton-3":{
    location:"Boston & Washington · Aftermath",
    title:"The Hunger for Credit",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true",
    wash:"var(--wash-amber)",
    text:`Morton begins to chase the impossible: to own the rights to a thing that could easily be made by anyone with a couple of bottles from the pharmacy and a willingness to use it. He calls this combination "Letheon” to disguise its simple formula. The taste was distinctive, and so orange oil was added to hide the taste even as he claimed a proprietary formula. His deception was discovered; Morton lost the patent. It was now simply available for all, without payment or recognition to himself. Each time someone administers ether without paying him, he feels it as theft. Each newspaper that prints another man's name as an innovator in this field makes him itch with rage.
The success that made him famous also made him vulnerable. Respect is addictive but so is applause. Equally so is the belief that you have changed the world and the world should keep kneeling to your greatness.`,
    choices:{ label:"", items:[{text:"Continue →", onSelect:()=>go("morton-end")}] }
  },
  "morton-end":{
    location:"Central Park · New York · July 1868",
    title:"The Pond in July",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/morton.png?raw=true",
    wash:"var(--wash-amber)",
    text:()=>{const tone=endingToneSentence("morton"); return `In July 1868, Morton read that Jackson had been honored overseas. It is a small article in a French newspaper, just ink and arrogance, but it detonates him anyway; he is apoplectic. He abandons his carriage and runs as though he can physically outpace humiliation, into the park, enraged. He plunges head first into a pond in Central Park as if the cold water could extinguish his fury. It does not. His body collapses on the bank. The last thing he is given by the grace of God is what he once administered to others: a swift internal shutdown, an erasure of sensation. An ambulance was called; he was dead on arrival. Morton had suffered a stroke, induced by exposure to ether as much as to his own all-consuming rage.${tone?`<br><br>${tone}`:""}<br><br><em>What does it mean to be witnessed only at the moment you vanish?</em>`;},
    choices:{ label:"Final choice", items:[
      {text:"Remain with the body.", onSelect:()=>goRemain("morton")},
      {text:"Return to the Dome.", onSelect:()=>go("epilogue"), fx:"sting"}
    ]}
  },

  "jackson-1":{
    location:"A Chemist's Study · Boston · 1846",
    title:"The Man Behind the Idea",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true",
    wash:"var(--wash-blue)",
    text:`Jackson is not the man in the room holding the anesthetic, and that fact feels like an insult carved into him. Ideas should matter more than a careless application of the physical. Theory should matter more than performance. The mind should outrank the spectacle. Yet the Dome is built for spectacle, built so that the crowd can watch the suffering and decide who deserves credit for diminishing it.
He tells himself he does not care for applause. That would be beneath him. What he cares for is accuracy, attribution. What he cares for is the cold, clean satisfaction of being right in a way that cannot be disputed for he has laid out each variable, with citation.
Jackson feels history is selecting the wrong narrative, and he feels himself being edited out in real time.`,
    choices:{ label:"Decision 1", items:[
      {text:"Confront immediately; make the room hear your claim", onSelect:()=>{bump("drive"); showHUD(); go("jackson-2a");}},
      {text:"Begin documenting quietly; build a dossier like a weapon", onSelect:()=>{bump("fracture"); showHUD(); go("jackson-2b");}}
    ]}
  },
  "jackson-2a":{
    location:"The Ether Dome · After the Cut",
    title:"Correcting the Story",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true",
    wash:"var(--wash-blue)",
    text:`You step forward when the room is still vibrating with disbelief, and you speak with the tone of a man correcting a child. You insist, politely and firmly, that the theory was yours, that the principle was yours, that the application was merely borrowed; the years of research was his, not Norton's. You do not raise your voice above the din. You do not make a scene. You behave like reason embodied, which is its own kind of aggression.
The room doesn't know what to do with you. They are drunk on the miracle and they want to celebrate. Your insistence feels like a cold hand on the throat of their joy; this is envy, they believe. Some men nod; others avoid your eyes. You realize, abruptly, that being right is not the same as being rewarded for it.`,
    choices:{ label:"Decision 2", items:[
      {text:"Pursue public validation through societies and committees", onSelect:()=>{bump("drive"); go("jackson-3");}},
      {text:"Turn inward, refine the argument until it becomes a labyrinth", onSelect:()=>{bump("fracture"); go("jackson-3");}}
    ]}
  },
  "jackson-2b":{
    location:"The Ether Dome · After the Cut",
    title:"The Dossier",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true",
    wash:"var(--wash-blue)",
    text:`You say nothing, because you understand how crowds work. You understand that applause has its own momentum and will crush anything delicate beneath it. You begin collecting evidence the way a physician documents symptoms. Letters. Dates. Prior conversations. The scent of orange oil. Morton's debts. Morton's habits. Morton's history of invention as showmanship.
You tell yourself this is not personal. You tell yourself you are defending truth.
But dossiers have a way of becoming an obsession. Each document feels like a bead on a rosary you cannot stop counting.`,
    choices:{ label:"Decision 2", items:[
      {text:"Present the dossier to Congress as proof of theft", onSelect:()=>{bump("drive"); go("jackson-3");}},
      {text:"Seek acclaim abroad; force Europe to validate you", onSelect:()=>{bump("fracture"); go("jackson-3");}}
    ]}
  },
  "jackson-3":{
    location:"Boston · The Long Argument",
    title:"A Mind Built for Combat",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true",
    wash:"var(--wash-blue)",
    text:`Your letters multiply. Your tone sharpens. The language becomes the weapon and then, becomes the cage. The more you write, the more you realize that you can stop writing. The world moves forward anyway, and your claim becomes the background hum of progress: persistent, irritating, easily ignored. Nobody likes a know-it-all.
Without the struggle over credit, you have no architecture for your mind to inhabit. You do what you know - you continue, one more time around the bend.`,
    choices:{ label:"", items:[{text:"Continue →", onSelect:()=>go("jackson-end")}] }
  },
  "jackson-end":{
    location:"McLean Hospital · Belmont, Massachusetts · 1873–1880",
    title:"The Guest at McLean",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/jackson.png?raw=true",
    wash:"var(--wash-blue)",
    text:()=>{const tone=endingToneSentence("jackson"); return `Rumor places Jackson at Morton's grave, reading the tombstone inscription with the kind of stare people reserve for betrayal. Whether he was truly there does not matter; what matters is that the story fits. He seizes suddenly and collapses. He is admitted to McLean, the well respected mental institution, to be cared for by a medical community that truly respects his brilliance even as they quietly lock him away from public argument. The seizures worsen.
Then a stroke takes his language, his one and  only weapon. He tries to form the sentence one more time. "I was the innovator!" The grammar dissolves before it can assemble. The thought survives, but it has no mouth to speak it.
He lived quietly, declining, until 1880. He became immobile, seemingly no longer present…but in truth he was in his own hell, aware of those around him and unable to communicate his presence. He was left largely alone with his thoughts. It was a long 7 years before his death; surely he went mad.${tone?`<br><br>${tone}`:""}<br><br>He lives quietly, declining, until 1880. No one argues with him. There is nothing left to argue about.`;},
    choices:{ label:"Final choice", items:[
      {text:"Remain with the body.", onSelect:()=>goRemain("jackson")},
      {text:"Return to the Dome.", onSelect:()=>go("epilogue"), fx:"sting"}
    ]}
  },

  "wells-1":{
    location:"Hartford, Connecticut · 1844",
    title:"Before the Dome",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true",
    wash:"var(--wash-ash)",
    text:`Wells saw it first. He watched a man under nitrous oxide injure himself without noticing, and the future opened before him like a crack in the wall. The next day he had his own tooth pulled under gas and felt nothing. It was not a trick, nor was it theater. It was mercy, real and immediate, and Wells believed he had touched something holy: the possibility of working the body without torturing the mind. 
Then his public demonstration failed. A cry. A laugh. A chorus of students calling him humbug. The word stuck to him the way soot sticks to a lamp glass.  He carried it back to Hartford like a wound. He conferred with Morton, his business partner - perhaps he could bring this vision legitimacy.
When ether succeeds in the Dome, Wells doesn't feel vindicated, or credited. He feels like the world couldn't see him, and that he was at fault for this. After all it was he who had taken his discovery, polished it, and handed it to someone else for fear of mockery. His own cowardice was at fault.
What he learns in the years after is not science, but a personal lesson. He learns what oblivion feels like. Not sleep, nor death but something else: the controlled annihilation of self.`,
    choices:{ label:"Decision 1", items:[
      {text:"Try again publicly; force redemption into the open", onSelect:()=>{bump("drive"); showHUD(); go("wells-2a");}},
      {text:"Withdraw; experiment privately; chase relief without witnesses", onSelect:()=>{bump("fracture"); showHUD(); go("wells-2b");}}
    ]}
  },
  "wells-2a":{
    location:"Boston & Hartford · Aftermath",
    title:"The Reach for Redemption",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true",
    wash:"var(--wash-ash)",
    text:`You pursue redemption the way a drowning man pursues air. You write, travel. You place yourself back in rooms that smell like chemicals and hope the world will see its saviors. Each attempt brings you closer to the feeling you want: the moment where the audience looks at you and realizes they were wrong.
But the world is already moving. Ether has become the headline. Your name has become a footnote…barely. You feel yourself thinning. You begin to crave the one place where failure cannot reach you: the soft-edged quiet inside anesthesia.`,
    choices:{ label:"Decision 2", items:[
      {text:"Treat chloroform as research; observe yourself clinically", onSelect:()=>{bump("drive"); go("wells-3");}},
      {text:"Treat chloroform as refuge; seek silence from shame", onSelect:()=>{bump("fracture"); go("wells-3");}}
    ]}
  },
  "wells-2b":{
    location:"New York · Private Rooms",
    title:"A Door Out of Feeling",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true",
    wash:"var(--wash-ash)",
    text:`You withdraw because crowds have learned your face. You withdraw because laughter has a way of waiting in corners, ready to greet you. You tell yourself that your solitude will allow more focus, you will pull yourself together from this embarrassment. You tell yourself that privacy is a laboratory condition to prevent the further contagion of shame in your mind. But what you are really doing is building a tomb in which to seal that shame.
Chloroform becomes familiar to you. It is just slightly less rough on the throat and lungs than diethyl ether. First an object of study. Then a companion that soothes your nerves, quiets your internal judgement. Then, it becomes a requirement to function. Under its influence, your humiliation loosens, past fears become distant. The nervous system is quieted, and quiet begins to feel like peace.
You begin to realize something no one in the Dome understood: anesthesia is not just the removal of pain. It is the voluntary suspension of being present. The gift removes even mental pain, mercifully. You believe you have sealed the wound of your shame yet in truth, it continues to bleed slowly beneath the skin`,
    choices:{ label:"Decision 2", items:[
      {text:"Keep control: study the effects, measure, document", onSelect:()=>{bump("drive"); go("wells-3");}},
      {text:"Let go: seek oblivion, not as escape but as practice", onSelect:()=>{bump("fracture"); go("wells-3");}}
    ]}
  },
  "wells-3":{
    location:"New York City · 1847–1848",
    title:"Rehearsing Absence",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true",
    wash:"var(--wash-ash)",
    text:`You try to turn the study of the gas into novelty again. You try to convince yourself that your discipline can separate the chemical innovation from the hunger it creates. But each time you inhale, you feel the same perverse relief: the temporary absence of self. The body becomes southern, the mind and its fear, distant. The world is muted.
You understand, too late, that the Dome did not merely change surgery. It introduced an option into human life: that consciousness can be placed in containment, away from the body. You have been practicing that step for months. Years.`,
    choices:{ label:"", items:[{text:"Continue →", onSelect:()=>go("wells-end")}] }
  },
  "wells-end":{
    location:"A Jail Cell · New York · January 24, 1848",
    title:"Letters to Those He Loved",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/wells.png?raw=true",
    wash:"var(--wash-ash)",
    text:()=>{
      const op=0.18 + (State.fracture/5)*0.62;
      setDomeBleed(op);
      const tone=endingToneSentence("wells");
      return `In January 1848, under chloroform, you did something that will be described later as madness. You sought refuge from your family in New York City to work. When you couldn't work, you sought pleasure in the arms of working girls nearby. Until a dispute between yourself and your favorite. You only meant to speak harshly in confronting her; you dosed yourself in order to pull the angry away into the shadows. Instead you threw vitriol, sulfuric acid, at her and her companions. Her face ruined, you were arrested, bond set high. The story becomes scandal, and scandal becomes confirmation for the people who always wanted you to be a fraud. You are allowed one courtesy before the cell door closes: to retrieve your toiletries, your bag, your personal effects. Authority offers a final respite.
In the cell, you write letters, the voice it carries is more present than you've been in months. You write with a strange calm, as if you have already stepped away. Your hand does not shake, the words are lucid. That lucidity is the worst part. 
Then you do what you have been practicing : you remove yourself.
Each inhalation over the past months was a rehearsal, a private experiment was a further retreat. You learned the exact interval between consciousness and its soft surrender. You learned how long the body fights before it stops insisting. The door you are about to walk through was built in the Ether Dome years ago. You have simply been turning up the cottage to enter it.
You pour chloroform into your fine silk handkerchief, and after a moment of consideration, stuff it into your mouth. You grimace at the taste. Next you take your scarf and wrap it across your face to assure that when you become unconscious you remain so. You understand the chemistry, and that your timeline is limited. You understand, with clinical clarity, what it means to be present and then to simply be gone. Sensation will move aside, the body can be cut. There is a small window of time between the ability to act, and loss of that function.
This is the explicit horror: the Dome did not only teach physicians how to silence pain. It taught human beings that they can choose to step outside themselves. If God will not hear a petition for peace, man can take it for themselves. Prometheus did us no favors; darkness is to be reclaimed. You brace yourself for the last flare of light.
Your razor opens your flesh, precisely where your thigh meets your pelvis. The darkness arrives, blessed anesthesia, the cessation of all pain. The last sensation is not agony, but …relief.
Years away, the Ether Dome stands unchanged, its pale curvature as indifferent and watchful as it ever was. As the edges of your vision narrows, the shape of that ceiling overlays the darkness behind your eyes. The architecture, the room in which the excision of pain was first demonstrated, becomes the room in your mind where you finally disappear completely.${tone?`<br><br>${tone}`:""}<br><br>And somewhere, years away, the Ether Dome stands unchanged, its pale curvature indifferent and watchful. As your vision narrows, the shape of that ceiling overlays the darkness behind your eyes. The architecture returns—not as memory, but as structure. The room that first demonstrated the disappearance of pain becomes the room in which you finally disappear yourself.`;
    },
    choices:{ label:"Final choice", items:[
      {text:"Remain with the body.", onSelect:()=>goRemain("wells")},
      {text:"Return to the Dome.", onSelect:()=>go("epilogue"), fx:"sting"}
    ]}
  },

  epilogue:{
    location:"The Ether Dome · After",
    title:"The Architecture of Silence",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/dome.png?raw=true",
    wash:null,
    text:`The Ether Dome empties. Boots descend the stairs. The chair remains centered, waiting to receive. The room holds the faint sweetness of ether as though it has soaked into plaster. If you stand there long enough, you can imagine how profound the silence that ether brought with it was.
The first time a body was gifted unconsciousness in the name of mercy, humanity discovered something that extends far beyond surgery: that consciousness can be suspended voluntarily, without death, without sleep, without narrative closure, but pause. Pain was not defeated but bypassed. The self was not destroyed; it was set aside to wait for the light to return. 
The demonstration had been a triumph. The triumph made it a tool. That tool became a habit, for some. Death, for others. 
Momento Mori.`,
    choices:{ label:"", items:[{text:"↩ Return to the Dome — Begin Again", onSelect:()=>boot()}] }
  },

  "return":{
    location:"Massachusetts General Hospital · Boston · October 16, 1846",
    title:"The Dome Remembers",
    portrait:"https://github.com/FaeMayhem/Ether-Dome-Twine-/blob/main/assets/img/dome.png?raw=true",
    wash:null,
    text:`The room has not changed. The seats are still arranged in their patient arcs, the skylight still presses its pale disc into the ceiling, the faint sweetness of ether still clings to plaster and wood. But you have changed. You carry a death with you now, and the Dome knows it.
The architecture does not judge. It simply waits, the way operating theaters always wait: for the next body, the next question, the next man willing to stake everything on a single demonstration.
Other fates still linger here. Other voices still echo beneath the dome's curvature, waiting to be followed. The history of anesthesia was not written by one hand, and the room will reshape itself around whichever gaze you choose next.`,
    choices:{ label:"Whose story will you enter?", items:[]},
    buildChoices:function(){
      const items=[];
      const all=[
        {doc:"morton", text:"William Morton — ambitious, late, reeking of orange oil"},
        {doc:"jackson", text:"Charles Jackson — the mind behind the idea, furious at erasure"},
        {doc:"wells", text:"Horace Wells — the pioneer the room once mocked"}
      ];
      const remaining = all.filter(d => !State.completed.includes(d.doc));
      const done = all.filter(d => State.completed.includes(d.doc));
      remaining.forEach(d => {
        items.push({text: d.text, onSelect:()=>enterDoctor(d.doc)});
      });
      if(remaining.length === 0){
        items.push({text:"All three fates have been witnessed. Begin again from the start.", onSelect:()=>{State.completed=[]; boot();}});
      }
      if(done.length > 0 && remaining.length > 0){
        done.forEach(d => {
          items.push({text: "↺ " + d.text + " (revisit)", onSelect:()=>enterDoctor(d.doc)});
        });
      }
      return items;
    }
  }
};

function go(key){
  if(key==="epilogue" && State.doctor!=="none" && !State.completed.includes(State.doctor)){
    State.completed.push(State.doctor);
  }
  if(!["wells-2a","wells-2b","wells-3","wells-end"].includes(key)) setDomeBleed(0);
  const p=passages[key]; if(!p) return; render(p);
}

function render(p){
  window.scrollTo({top:0, behavior:"smooth"});
  hideChoices();
  elLocation.textContent=p.location||"";
  elTitle.textContent=p.title||"";
  
  if(p.portrait){
    elPortrait.src=p.portrait;
    elPortrait.alt=p.title||"Portrait";
    elPortrait.style.display="block";
  } else {
    elPortrait.style.display="none";
    elPortrait.removeAttribute("src");
  }
  if(p.wash) setWash(p.wash); else setWash(null);

  updateMeters();
  if(State.meterShown) elHUD.classList.add("visible");

  const html = (typeof p.text==="function") ? p.text() : p.text;
  const ch = p.choices || {label:"", items:[]};
  if(p.buildChoices) ch.items = p.buildChoices();

  // Split text into paragraphs
  let normalized = html.replace(/\n\s*\n/g, '<br><br>').replace(/\n/g, '<br><br>');
  const rawParas = normalized.split(/<br\s*\/?>\s*<br\s*\/?>/gi).filter(c => c.trim());
  
  // Break oversized paragraphs into smaller pieces (by sentences)
  const MAX_CHARS = 400;
  const paras = [];
  rawParas.forEach(p => {
    if(p.length <= MAX_CHARS){
      paras.push(p);
    } else {
      // Split on sentence boundaries
      const sentences = p.match(/[^.!?]+[.!?]+[\s]*/g) || [p];
      let chunk = "";
      sentences.forEach(s => {
        if(chunk.length + s.length > MAX_CHARS && chunk.length > 0){
          paras.push(chunk.trim());
          chunk = s;
        } else {
          chunk += s;
        }
      });
      if(chunk.trim()) paras.push(chunk.trim());
    }
  });
  
  // Group into pages of 2-3 paragraphs
  const PARAS_PER_PAGE = 2;
  const pages = [];
  for(let i = 0; i < paras.length; i += PARAS_PER_PAGE){
    pages.push(paras.slice(i, i + PARAS_PER_PAGE).join('<br><br>'));
  }
  
  // If short enough, just show it all at once
  if(pages.length <= 1){
    elSkip.style.display = "inline-block";
    fadeInLines(elText, html||"", ()=>{
      elSkip.style.display = "none";
      setTimeout(()=>revealChoices(ch.label||"", ch.items||[]), 240);
    });
    return;
  }
  
  // Show pages one at a time
  let pageIndex = 0;
  function showPage(){
    window.scrollTo({top:0, behavior:"smooth"});
    hideChoices();
    const isLast = (pageIndex >= pages.length - 1);
    
    elSkip.style.display = "inline-block";
    fadeInLines(elText, pages[pageIndex], ()=>{
      elSkip.style.display = "none";
      if(isLast){
        setTimeout(()=>revealChoices(ch.label||"", ch.items||[]), 240);
      } else {
        // Show a "Continue reading" button
        setTimeout(()=>{
          revealChoices("", [{
            text:"Continue reading →",
            onSelect:()=>{
              pageIndex++;
              showPage();
            }
          }]);
        }, 240);
      }
    });
  }
  showPage();
}

function boot(){
  resetState();
  updateMeters();
  hideHUD();
  if(State.completed.length > 0){
    go("return");
  } else {
    go("start");
  }
}
boot();
</script>
</body>
</html>
