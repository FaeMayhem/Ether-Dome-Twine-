<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Ether Dome — A Tale of Three Fates</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IM+Fell+English:ital@0;1&display=swap');

  :root {
    --ink: #0e0c08;
    --parchment: #f5edd8;
    --blood: #7a1c1c;
    --ether-blue: #2a4a5a;
    --gold: #8b6914;
    --fade: #6b5c3e;
    --bg-color: #0e0c08;
    --accent: #8b6914;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--bg-color);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    transition: background-color 2s ease;
    position: relative;
    overflow-x: hidden;
  }

  /* =====================
     ATMOSPHERIC OVERLAYS
     ===================== */

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    transition: opacity 2s ease;
    background: var(--atmosphere, transparent);
  }

  body.atmosphere-morton::before {
    opacity: 1;
    background: radial-gradient(ellipse at 30% 40%, rgba(42,74,90,0.25) 0%, transparent 65%),
                radial-gradient(ellipse at 80% 80%, rgba(20,40,55,0.2) 0%, transparent 50%);
  }
  body.atmosphere-jackson::before {
    opacity: 1;
    background: radial-gradient(ellipse at 70% 30%, rgba(100,70,20,0.2) 0%, transparent 60%),
                radial-gradient(ellipse at 20% 70%, rgba(80,50,10,0.15) 0%, transparent 50%);
  }
  body.atmosphere-wells::before {
    opacity: 1;
    background: radial-gradient(ellipse at 50% 60%, rgba(122,28,28,0.2) 0%, transparent 65%),
                radial-gradient(ellipse at 20% 20%, rgba(80,10,10,0.1) 0%, transparent 50%);
  }

  /* Subtle noise texture overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    opacity: 0.04;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  }

  /* =====================
     VIGNETTE
     ===================== */
  .vignette {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.7) 100%);
  }

  /* =====================
     MAIN LAYOUT
     ===================== */
  #game {
    max-width: 680px;
    width: 100%;
    position: relative;
    z-index: 2;
  }

  /* =====================
     AUDIO CONTROLS
     ===================== */
  #audio-controls {
    position: fixed;
    top: 1.2rem;
    right: 1.2rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #audio-toggle {
    background: transparent;
    border: 1px solid rgba(139,105,20,0.4);
    color: var(--gold);
    font-family: 'IM Fell English', serif;
    font-size: 0.75rem;
    padding: 0.35rem 0.7rem;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 0.05em;
  }
  #audio-toggle:hover { background: rgba(139,105,20,0.1); border-color: var(--gold); }
  #audio-toggle.muted { opacity: 0.4; }

  /* =====================
     PASSAGES
     ===================== */
  .passage { display: none; }
  .passage.active { display: block; }

  /* =====================
     TYPEWRITER
     ===================== */
  .typewriter-container { overflow: hidden; }

  /* character reveal handled via JS opacity */

  /* Fade in for non-typewriter elements */
  .fade-in {
    opacity: 0;
    animation: fadeIn 0.6s ease forwards;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  /* =====================
     TEXT ELEMENTS
     ===================== */
  .location-tag {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 1.5rem;
    opacity: 0.85;
  }

  h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 400;
    font-style: italic;
    color: var(--parchment);
    margin-bottom: 1.2rem;
    line-height: 1.3;
    border-bottom: 1px solid rgba(139,105,20,0.3);
    padding-bottom: 1rem;
  }

  .narrator {
    font-size: 1.05rem;
    line-height: 1.9;
    color: #e8d9bc;
    margin-bottom: 1rem;
  }

  .narrator em { color: var(--parchment); font-style: italic; }
  .narrator .grim { color: #c49a9a; font-style: italic; }

  /* =====================
     CHOICES
     ===================== */
  .choices {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    opacity: 0;
    transition: opacity 0.8s ease;
  }
  .choices.visible { opacity: 1; }

  .choice-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--fade);
    margin-bottom: 0.5rem;
  }

  button.choice {
    background: transparent;
    border: 1px solid rgba(139,105,20,0.35);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    font-size: 0.95rem;
    padding: 0.85rem 1.2rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.3s ease;
    line-height: 1.5;
    position: relative;
    overflow: hidden;
  }

  button.choice::after {
    content: '';
    position: absolute;
    left: 0; top: 0;
    width: 0; height: 100%;
    background: rgba(139,105,20,0.06);
    transition: width 0.3s ease;
  }

  button.choice::before {
    content: '❧';
    color: var(--gold);
    margin-right: 0.6rem;
    opacity: 0;
    transition: opacity 0.2s;
    position: relative;
    z-index: 1;
  }

  button.choice:hover { border-color: rgba(139,105,20,0.7); }
  button.choice:hover::before { opacity: 1; }
  button.choice:hover::after { width: 100%; }

  .fate-tag {
    display: inline-block;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.12rem 0.45rem;
    border-radius: 2px;
    margin-left: 0.5rem;
    vertical-align: middle;
  }
  .fate-morton { background: rgba(42,74,90,0.4); color: #8fb8cc; }
  .fate-jackson { background: rgba(80,50,20,0.4); color: #c9a96e; }
  .fate-wells { background: rgba(122,28,28,0.3); color: #d4888a; }

  /* =====================
     ENDINGS
     ===================== */
  .ending-banner {
    font-family: 'Playfair Display', serif;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--gold);
    text-align: center;
    margin-bottom: 2rem;
    opacity: 0.8;
  }

  .restart-btn {
    margin-top: 2.5rem;
    display: block;
    width: 100%;
    background: transparent;
    border: 1px solid rgba(139,105,20,0.4);
    color: var(--gold);
    font-family: 'Playfair Display', serif;
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    padding: 0.8rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  .restart-btn:hover { background: rgba(139,105,20,0.1); }

  /* =====================
     PROGRESS PIPS
     ===================== */
  .progress {
    display: flex;
    gap: 5px;
    margin-bottom: 2rem;
  }
  .progress-pip {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: rgba(139,105,20,0.15);
    border: 1px solid rgba(139,105,20,0.35);
    transition: background 0.4s, border-color 0.4s;
  }
  .progress-pip.filled { background: var(--gold); border-color: var(--gold); }

  /* =====================
     CANDLE FLICKER
     ===================== */
  .candle-glow {
    position: fixed;
    width: 200px; height: 200px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: candleFlicker 4s ease-in-out infinite alternate;
  }
  .candle-glow.left {
    bottom: 10%; left: -60px;
    background: radial-gradient(circle, rgba(180,120,20,0.12) 0%, transparent 70%);
  }
  .candle-glow.right {
    top: 15%; right: -60px;
    background: radial-gradient(circle, rgba(180,120,20,0.08) 0%, transparent 70%);
    animation-delay: -2s;
  }

  @keyframes candleFlicker {
    0%   { transform: scale(1) translate(0,0); opacity: 1; }
    25%  { transform: scale(1.05) translate(3px, -2px); opacity: 0.9; }
    50%  { transform: scale(0.97) translate(-2px, 1px); opacity: 1; }
    75%  { transform: scale(1.02) translate(1px, -3px); opacity: 0.85; }
    100% { transform: scale(1) translate(-1px, 0); opacity: 0.95; }
  }

  /* =====================
     SCROLL FADE-IN
     ===================== */
  @media (prefers-reduced-motion: no-preference) {
    .scroll-reveal {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .scroll-reveal.revealed {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
</head>
<body>

<!-- Atmospheric elements -->
<div class="vignette"></div>
<div class="candle-glow left"></div>
<div class="candle-glow right"></div>

<!-- Audio controls -->
<div id="audio-controls">
  <button id="audio-toggle" onclick="toggleAudio()">♪ Ambience ON</button>
</div>

<div id="game">

<!-- ==================== START ==================== -->
<div class="passage active" id="p-start">
  <div class="location-tag fade-in" style="animation-delay:0.2s">Massachusetts General Hospital · Boston · October 16, 1846</div>
  <div class="progress fade-in" style="animation-delay:0.4s">
    <div class="progress-pip filled"></div>
    <div class="progress-pip"></div>
    <div class="progress-pip"></div>
    <div class="progress-pip"></div>
  </div>
  <h2 class="fade-in" style="animation-delay:0.5s">The Ether Dome</h2>
  <div class="typewriter-container">
    <p class="narrator" id="tw-start">Before the merciful veil of anesthesia, surgery was nothing less than a <em>waking nightmare</em>. Operating theaters were placed as far from the healing wards as possible — anywhere the hallways would not carry the sound of screaming.<br><br>
    Today, inside the stone dome atop Massachusetts General Hospital, history holds its breath. Three men stand at the edge of a revolution that will transform medicine forever. Each believes the credit is his. Each is wrong about what the victory will cost him.<br><br>
    <em>You are the witness. Choose whose fate you will follow.</em></p>
  </div>
  <div class="choices" id="choices-start">
    <div class="choice-label">Whose story will you enter?</div>
    <button class="choice" onclick="show('p-morton-1', 'morton')">William Morton — the ambitious dentist who arrived late, reeking of orange oil <span class="fate-tag fate-morton">Morton</span></button>
    <button class="choice" onclick="show('p-jackson-1', 'jackson')">Charles Jackson — the chemist who whispered the idea into Morton's ear, and never forgave him <span class="fate-tag fate-jackson">Jackson</span></button>
    <button class="choice" onclick="show('p-wells-1', 'wells')">Horace Wells — the mentor, the true pioneer, the one history forgot <span class="fate-tag fate-wells">Wells</span></button>
  </div>
</div>

<!-- ==================== MORTON 1 ==================== -->
<div class="passage" id="p-morton-1">
  <div class="location-tag">The Ether Dome · Demonstration Day</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div><div class="progress-pip"></div></div>
  <h2>Morton's Grand Entrance</h2>
  <p class="narrator" data-typewrite>Morton arrives late — breathless, his apparatus smelling faintly of orange. Dr. Warren had already told the assembled students: <em>"As Dr. Morton has not arrived, I presume he is otherwise engaged."</em> The laughter barely fades before Morton bursts through the door.<br><br>
  The patient, a young printer named Gilbert Abbott, lies strapped to the chair. Morton fits the glass globe inhaler to his face. The room falls silent. Abbott's eyes go glassy. His body slackens.<br><br>
  Dr. Warren cuts. Abbott does not scream.<br><br>
  <em>"Gentlemen,"</em> Warren announces, his voice ringing off the stone dome, <em>"this is no humbug."</em><br><br>
  Morton basks in the applause — but already, he is scheming. The orange oil is not flavoring. It is camouflage. He intends to patent ether and grow rich from every surgery on earth.</p>
  <div class="choices">
    <div class="choice-label">What does Morton do next?</div>
    <button class="choice" onclick="show('p-morton-patent', 'morton')">Morton pursues the patent — filing under the name "Letheon" to obscure the simple truth of ether</button>
    <button class="choice" onclick="show('p-morton-congress', 'morton')">Morton petitions Congress for financial reward — demanding recognition as the sole inventor</button>
  </div>
</div>

<!-- ==================== MORTON PATENT ==================== -->
<div class="passage" id="p-morton-patent">
  <div class="location-tag">The Courts · Boston · 1847</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>The Smell of Orange Oil</h2>
  <p class="narrator" data-typewrite>The patent is granted — briefly. But the secret cannot hold. A chemist's nose, a curious colleague, a simple analysis: the orange oil is stripped away, and beneath it lies nothing but plain ether. Any apothecary sells it for pennies.<br><br>
  The patent collapses.<br><br>
  Charles Jackson, who claims he <em>gave</em> Morton the idea, begins assembling a dossier — every swindle Morton ever committed, every debt unpaid. He brings it before Congress. The Court refuses to admit it.<br><br>
  Morton spends his remaining years in litigation and debt. His mind circles the same wound obsessively: <em>I showed them. I showed them and they took it from me.</em></p>
  <div class="choices"><button class="choice" onclick="show('p-morton-end', 'morton')">Continue to Morton's end →</button></div>
</div>

<!-- ==================== MORTON CONGRESS ==================== -->
<div class="passage" id="p-morton-congress">
  <div class="location-tag">Washington D.C. · 1860s</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>The Petitioner</h2>
  <p class="narrator" data-typewrite>Morton writes letters. Morton appears before committees. Morton hires lawyers with money he does not have. Congress debates, deliberates, and declines.<br><br>
  The war absorbs everything. Ether flows freely across every battlefield — <em>his</em> ether, he insists — and not a cent reaches him.<br><br>
  At home, creditors circle. His wife watches him grow thin and strange. He speaks of little else: <em>Jackson is stealing my credit. They will see. They will see.</em></p>
  <div class="choices"><button class="choice" onclick="show('p-morton-end', 'morton')">Continue to Morton's end →</button></div>
</div>

<!-- ==================== MORTON END ==================== -->
<div class="passage" id="p-morton-end">
  <div class="location-tag">Central Park · New York · July 1868</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div></div>
  <div class="ending-banner">∴ The Fate of Morton ∴</div>
  <h2>The Pond in July</h2>
  <p class="narrator" data-typewrite>In the summer of 1868, Morton reads in a French newspaper that Charles Jackson has received accolades in Paris for <em>inventing</em> ether anesthesia.<br><br>
  He goes <span class="grim">apoplectic</span>.<br><br>
  He abandons his carriage mid-ride. He runs toward the pond in Central Park, tearing at his collar, and plunges into the water to cool himself. He does not cool. He collapses on the bank.<br><br>
  An ambulance is called, but he is dead before he arrives at the hospital. A stroke. The risks of repeated exposure to chloroform and ether include severe cardiovascular damage — as later understood.<br><br>
  He was fifty-seven years old, penniless, and raging. He died as he lived: convinced the world owed him something it would never pay.<br><br>
  <em>His tombstone reads: "Inventor and Revealer of Anaesthetic Inhalation." Jackson had one put up claiming the same.</em></p>
  <button class="restart-btn" onclick="show('p-start', 'none')">↩ Return to the Dome — Choose Another Fate</button>
</div>

<!-- ==================== JACKSON 1 ==================== -->
<div class="passage" id="p-jackson-1">
  <div class="location-tag">A Chemist's Study · Boston · 1846</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div><div class="progress-pip"></div></div>
  <h2>The Man Behind the Idea</h2>
  <p class="narrator" data-typewrite>Charles Jackson did not stand in the Dome that day. He sent Morton in his place — or so Jackson tells it.<br><br>
  In his version, Morton was barely a student, a dentist fumbling with gases, and it was <em>Jackson's mind</em> that conceived of ether's anesthetic use. He merely needed someone to demonstrate it.<br><br>
  This is Jackson's great tragedy: he may even be telling the truth.<br><br>
  But the world gave credit to the man who held the inhaler. Jackson paces his study, composing letters to learned societies, to Congress, to anyone who will listen. He has done this before — he claimed Samuel Morse stole the telegraph from a conversation on a steamship. He is a man of real genius. And of real obsession.</p>
  <div class="choices">
    <div class="choice-label">How does Jackson press his claim?</div>
    <button class="choice" onclick="show('p-jackson-dossier', 'jackson')">Jackson compiles a dossier of Morton's fraudulent past — and brings it before Congress</button>
    <button class="choice" onclick="show('p-jackson-europe', 'jackson')">Jackson turns to Europe — where the scientific societies are more willing to listen</button>
  </div>
</div>

<!-- ==================== JACKSON DOSSIER ==================== -->
<div class="passage" id="p-jackson-dossier">
  <div class="location-tag">The Courts · 1850s</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>The Dossier</h2>
  <p class="narrator" data-typewrite>Jackson is thorough. He assembles a portrait of Morton as a swindler: debts unpaid, partnerships dissolved under suspicious circumstances, a man whose entire career is a series of confident frauds. The file is thick.<br><br>
  The Court examines it.<br><br>
  The Court <em>refuses to admit it.</em><br><br>
  Morton's past is deemed irrelevant to the question of discovery. Jackson rages. He writes more letters. The dispute becomes the background noise of both men's lives — a low hum of mutual destruction that neither can silence nor win.</p>
  <div class="choices"><button class="choice" onclick="show('p-jackson-end', 'jackson')">Continue to Jackson's end →</button></div>
</div>

<!-- ==================== JACKSON EUROPE ==================== -->
<div class="passage" id="p-jackson-europe">
  <div class="location-tag">Paris · 1850s</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>Accolades Across the Water</h2>
  <p class="narrator" data-typewrite>The French Académie de Médecine awards Jackson a prize. European scientists, removed from the politics of Boston, find his claim credible. For a brief, warm season, Jackson feels vindicated.<br><br>
  Then the news reaches Morton. His apoplectic collapse in Central Park, his death on the bank of the pond, becomes the final chapter of their war. Morton is gone. Jackson has outlived his enemy.<br><br>
  It does not feel like victory.<br><br>
  Without Morton to fight, Jackson loses the architecture of his obsession. Something comes undone in him.</p>
  <div class="choices"><button class="choice" onclick="show('p-jackson-end', 'jackson')">Continue to Jackson's end →</button></div>
</div>

<!-- ==================== JACKSON END ==================== -->
<div class="passage" id="p-jackson-end">
  <div class="location-tag">McLean Hospital · Belmont, Massachusetts · 1873–1880</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div></div>
  <div class="ending-banner">∴ The Fate of Jackson ∴</div>
  <h2>The Guest at McLean</h2>
  <p class="narrator" data-typewrite>One rumor — persistent enough to feel like truth — places Jackson at Morton's graveside, reading the tombstone's inscription. <em>Inventor and Revealer of Anaesthetic Inhalation.</em><br><br>
  Jackson suffers a seizure on the spot.<br><br>
  He is admitted to McLean Hospital — the famous asylum on the hill — as a <span class="grim">guest at no cost.</span> The medical community, which held genuine respect for his real contributions, cares for him without charge.<br><br>
  A stroke later takes the language centers of his brain. The man whose only weapon was words — arguments, letters, testimonies — is left without them.<br><br>
  He lives quietly, declining, until 1880. No one argues with him. There is nothing left to argue about.</p>
  <button class="restart-btn" onclick="show('p-start', 'none')">↩ Return to the Dome — Choose Another Fate</button>
</div>

<!-- ==================== WELLS 1 ==================== -->
<div class="passage" id="p-wells-1">
  <div class="location-tag">Hartford, Connecticut · 1844</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div><div class="progress-pip"></div></div>
  <h2>Before the Dome</h2>
  <p class="narrator" data-typewrite>Horace Wells was there first.<br><br>
  A dentist in Hartford, he watched a laughing gas demonstration at a public entertainment — a man inhaled nitrous oxide, stumbled into a bench, gashed his leg on a nail, and felt nothing.<br><br>
  Wells had a tooth pulled the next day under nitrous oxide. He felt nothing either. He had already laid the groundwork for everything Morton would later be credited for.<br><br>
  But his public demonstration at Massachusetts General went wrong. The patient cried out. The students laughed. <em>Humbug!</em> they called him — the very same word Warren would later use to dismiss doubt about Morton's success.<br><br>
  Wells retreated to Hartford, humiliated. And Morton, his former student, moved forward without him.</p>
  <div class="choices">
    <div class="choice-label">How does Wells respond to his failure?</div>
    <button class="choice" onclick="show('p-wells-chloroform', 'wells')">Wells turns to chloroform — experimenting on himself, seeking relief he cannot find in waking life</button>
    <button class="choice" onclick="show('p-wells-paris', 'wells')">Wells travels to Paris — where he is, briefly, celebrated as the true discoverer</button>
  </div>
</div>

<!-- ==================== WELLS CHLOROFORM ==================== -->
<div class="passage" id="p-wells-chloroform">
  <div class="location-tag">New York City · 1847–1848</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>The Bottle and the Razor</h2>
  <p class="narrator" data-typewrite>Wells has taken rooms in New York. His wife does not know why he left Hartford.<br><br>
  The chloroform has been following him for years — first as a subject of study, then as a companion, then as a <span class="grim">necessity.</span> Under its influence, the humiliation at MGH softens. The laughter fades.<br><br>
  The Victorian era had its "frolics" — events where doctors demonstrated anesthetic gases recreationally, for family and colleagues alike. Wells told himself he was still conducting research. He was not.<br><br>
  Then, on a cold January evening, he goes out under its influence and throws acid — vitriol, sulfuric acid — at a group of women on the street. One woman's face is ruined. The police arrest him. The judge sets bond at over two thousand dollars.<br><br>
  Wells is allowed, as a courtesy to his standing as a doctor, to retrieve a toiletry bag before they lock him up.</p>
  <div class="choices"><button class="choice" onclick="show('p-wells-end', 'wells')">Continue to Wells' end →</button></div>
</div>

<!-- ==================== WELLS PARIS ==================== -->
<div class="passage" id="p-wells-paris">
  <div class="location-tag">Paris · 1847</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip"></div></div>
  <h2>Recognition, Briefly</h2>
  <p class="narrator" data-typewrite>The Paris Medical Society declares Wells the true discoverer of anesthesia. For a moment, the warmth of it is real. He writes home. He is vindicated.<br><br>
  But Morton's demonstration was more dramatic. More public. More American. The newspapers in Boston have already written their story, and it does not include Wells.<br><br>
  He returns home. The recognition fades the way warmth fades — quickly, completely, leaving the cold feeling colder than before.<br><br>
  He begins to experiment more recklessly with the gases. The chloroform becomes less a subject and more a <span class="grim">companion.</span> Then more than a companion. He takes rooms in New York, away from everything except the bottle and the brief, floating silence it grants him.</p>
  <div class="choices"><button class="choice" onclick="show('p-wells-end', 'wells')">Continue to Wells' end →</button></div>
</div>

<!-- ==================== WELLS END ==================== -->
<div class="passage" id="p-wells-end">
  <div class="location-tag">A Jail Cell · New York · January 24, 1848</div>
  <div class="progress"><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div><div class="progress-pip filled"></div></div>
  <div class="ending-banner">∴ The Fate of Wells ∴</div>
  <h2>Letters to Those He Loved</h2>
  <p class="narrator" data-typewrite>They let him take his bag.<br><br>
  Inside the bag, hidden beneath soap and a comb, is a small bottle of chloroform and his razor — which he has quietly resharpened into something else.<br><br>
  He sits on the edge of the cot and writes letters. To his wife. To his partners. To the colleagues who laughed at him. <em>The letters are lucid. Calm. They say goodbye without saying goodbye.</em><br><br>
  Then he pours the chloroform onto a new silk scarf and stuffs it into his own mouth, tying a second handkerchief over his face to hold it there — even as, with the hand that is still his own, he opens a <span class="grim">six-inch gash</span> at the juncture of the thigh and pelvis.<br><br>
  The darkness comes in like anesthesia. He feels nothing.<br><br>
  <em>He chose that, at least.</em><br><br>
  He was thirty-three years old. The American Dental Association later named him the true discoverer of modern anesthesia. He never knew.</p>
  <button class="restart-btn" onclick="show('p-start', 'none')">↩ Return to the Dome — Begin Again</button>
</div>

</div><!-- end #game -->

<script>
// =============================================
// AUDIO ENGINE — Web Audio API, no libraries
// =============================================

let audioCtx = null;
let masterGain = null;
let ambientNodes = [];
let audioRunning = false;
let audioEnabled = true;
let currentDoctor = 'none';

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.setValueAtTime(0.18, audioCtx.currentTime);
  masterGain.connect(audioCtx.destination);
}

// Generate ambient drone using oscillators + filtered noise
function startAmbience(doctor) {
  if (!audioEnabled || !audioCtx) return;
  stopAmbience();

  const now = audioCtx.currentTime;

  // Base drone — low rumble
  const droneFreqs = {
    none: [55, 82.5, 110],
    morton: [46.25, 55, 73.4],    // Cold, blue — low and unsettling
    jackson: [61.7, 82.5, 92.5],  // Warm amber — mid tension
    wells: [41.2, 55, 61.7],      // Darkest, deepest — dread
  };

  const freqs = droneFreqs[doctor] || droneFreqs.none;

  freqs.forEach((freq, i) => {
    const osc = audioCtx.createOscillator();
    const oscGain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, now);

    // Slight detuning for that unnerving shimmer
    const lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.frequency.setValueAtTime(0.08 + i * 0.03, now);
    lfoGain.gain.setValueAtTime(0.3, now);
    lfo.connect(lfoGain);
    lfoGain.connect(osc.frequency);
    lfo.start(now);

    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(300 + i * 80, now);

    oscGain.gain.setValueAtTime(0, now);
    oscGain.gain.linearRampToValueAtTime(0.35 - i * 0.08, now + 3);

    osc.connect(filter);
    filter.connect(oscGain);
    oscGain.connect(masterGain);
    osc.start(now);

    ambientNodes.push(osc, lfo, oscGain, lfoGain);
  });

  // Filtered noise — like distant wind or murmuring crowd
  const bufferSize = audioCtx.sampleRate * 4;
  const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuffer;
  noise.loop = true;

  const noiseFilter = audioCtx.createBiquadFilter();
  noiseFilter.type = 'bandpass';
  noiseFilter.frequency.setValueAtTime(120, now);
  noiseFilter.Q.setValueAtTime(0.5, now);

  const noiseGain = audioCtx.createGain();
  noiseGain.gain.setValueAtTime(0, now);
  noiseGain.gain.linearRampToValueAtTime(0.04, now + 4);

  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(masterGain);
  noise.start(now);

  ambientNodes.push(noise, noiseGain);
  audioRunning = true;
}

function stopAmbience() {
  ambientNodes.forEach(node => {
    try {
      node.stop && node.stop();
      node.disconnect && node.disconnect();
    } catch(e) {}
  });
  ambientNodes = [];
  audioRunning = false;
}

function crossfadeAmbience(newDoctor) {
  if (!audioEnabled || !audioCtx || newDoctor === currentDoctor) return;
  currentDoctor = newDoctor;
  if (newDoctor === 'none') {
    // Fade out
    if (masterGain) masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2);
    setTimeout(stopAmbience, 2100);
  } else {
    startAmbience(newDoctor);
    if (masterGain) {
      masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
      masterGain.gain.linearRampToValueAtTime(0.18, audioCtx.currentTime + 2.5);
    }
  }
}

// UI click sound — brief quill-scratch transient
function playClickSound() {
  if (!audioEnabled || !audioCtx) return;
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();

  osc.type = 'sawtooth';
  osc.frequency.setValueAtTime(800, now);
  osc.frequency.exponentialRampToValueAtTime(200, now + 0.08);

  filter.type = 'highpass';
  filter.frequency.setValueAtTime(400, now);

  gain.gain.setValueAtTime(0.15, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(masterGain);
  osc.start(now);
  osc.stop(now + 0.12);
}

// Heavier thud for endings
function playEndingSound() {
  if (!audioEnabled || !audioCtx) return;
  const now = audioCtx.currentTime;

  // Low thud
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(80, now);
  osc.frequency.exponentialRampToValueAtTime(30, now + 0.4);
  gain.gain.setValueAtTime(0.5, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
  osc.connect(gain);
  gain.connect(masterGain);
  osc.start(now);
  osc.stop(now + 0.6);

  // High shimmer
  const osc2 = audioCtx.createOscillator();
  const gain2 = audioCtx.createGain();
  osc2.type = 'sine';
  osc2.frequency.setValueAtTime(1800, now + 0.1);
  osc2.frequency.exponentialRampToValueAtTime(900, now + 0.8);
  gain2.gain.setValueAtTime(0, now);
  gain2.gain.linearRampToValueAtTime(0.06, now + 0.15);
  gain2.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
  osc2.connect(gain2);
  gain2.connect(masterGain);
  osc2.start(now + 0.1);
  osc2.stop(now + 1.3);
}

function toggleAudio() {
  initAudio();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  audioEnabled = !audioEnabled;
  const btn = document.getElementById('audio-toggle');
  if (audioEnabled) {
    btn.textContent = '♪ Ambience ON';
    btn.classList.remove('muted');
    startAmbience(currentDoctor === 'none' ? 'none' : currentDoctor);
  } else {
    btn.textContent = '♪ Ambience OFF';
    btn.classList.add('muted');
    stopAmbience();
  }
}

// =============================================
// TYPEWRITER ENGINE — stores full HTML, reveals
// by walking text nodes only, preserving tags
// =============================================

let typewriterTimeout = null;

function typewriteElement(el, onComplete) {
  // Save original HTML, clear the element
  const originalHTML = el.innerHTML;
  el.innerHTML = '';
  el.style.visibility = 'visible';

  // Build a flat list of {node, chars[]} by walking the DOM
  // We render the full HTML first into a hidden clone, then
  // walk its text nodes and reveal them char by char in place.
  const clone = document.createElement('div');
  clone.innerHTML = originalHTML;
  el.appendChild(clone);

  // Collect all text nodes in document order
  const textNodes = [];
  const walker = document.createTreeWalker(clone, NodeFilter.SHOW_TEXT, null, false);
  let node;
  while ((node = walker.nextNode())) {
    if (node.textContent.trim() !== '') {
      textNodes.push(node);
    }
  }

  if (textNodes.length === 0) {
    if (onComplete) onComplete();
    return;
  }

  // For each text node: hide all its text, then reveal char by char
  // Strategy: replace each text node with a <span> containing per-char <span>s
  const allCharSpans = [];

  textNodes.forEach(textNode => {
    const text = textNode.textContent;
    const wrapper = document.createElement('span');
    for (const ch of text) {
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.opacity = '0';
      wrapper.appendChild(span);
      allCharSpans.push(span);
    }
    textNode.parentNode.replaceChild(wrapper, textNode);
  });

  // Reveal characters one by one
  let i = 0;
  const baseDelay = 20;
  const variance = 14;

  function revealNext() {
    if (i >= allCharSpans.length) {
      if (onComplete) onComplete();
      return;
    }
    allCharSpans[i].style.opacity = '1';
    const ch = allCharSpans[i].textContent;

    let delay = baseDelay + Math.random() * variance;
    if (['.', '!', '?'].includes(ch)) delay += 130;
    else if (['—', '…'].includes(ch)) delay += 80;
    else if ([',', ';', ':'].includes(ch)) delay += 55;

    i++;
    typewriterTimeout = setTimeout(revealNext, delay);
  }

  revealNext();
}

// =============================================
// ATMOSPHERE MAPPING
// =============================================

const atmosphereMap = {
  'p-start': 'none',
  'p-morton-1': 'morton', 'p-morton-patent': 'morton', 'p-morton-congress': 'morton', 'p-morton-end': 'morton',
  'p-jackson-1': 'jackson', 'p-jackson-dossier': 'jackson', 'p-jackson-europe': 'jackson', 'p-jackson-end': 'jackson',
  'p-wells-1': 'wells', 'p-wells-chloroform': 'wells', 'p-wells-paris': 'wells', 'p-wells-end': 'wells',
};

const endingPassages = ['p-morton-end', 'p-jackson-end', 'p-wells-end'];

// =============================================
// PASSAGE NAVIGATION
// =============================================

function show(id, doctor) {
  // Init audio on first interaction
  if (!audioCtx) {
    initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  // Sound cues
  if (endingPassages.includes(id)) {
    playEndingSound();
  } else {
    playClickSound();
  }

  // Clear any running typewriter
  if (typewriterTimeout) clearTimeout(typewriterTimeout);

  // Atmosphere
  const atm = atmosphereMap[id] || 'none';
  const body = document.body;
  body.classList.remove('atmosphere-morton', 'atmosphere-jackson', 'atmosphere-wells');
  if (atm !== 'none') body.classList.add('atmosphere-' + atm);

  // Audio crossfade
  crossfadeAmbience(atm);

  // Hide all, show target
  document.querySelectorAll('.passage').forEach(p => p.classList.remove('active'));
  const target = document.getElementById(id);
  if (!target) return;
  target.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // Typewrite the narrator paragraph
  const twEl = target.querySelector('[data-typewrite]');
  const choices = target.querySelector('.choices');

  if (twEl) {
    if (choices) choices.classList.remove('visible');
    // Small delay before starting typewriter
    setTimeout(() => {
      typewriteElement(twEl, () => {
        // Reveal choices after text finishes
        if (choices) {
          setTimeout(() => choices.classList.add('visible'), 300);
        }
      });
    }, 400);
  } else {
    // No typewriter — just fade in choices
    if (choices) {
      setTimeout(() => choices.classList.add('visible'), 600);
    }
  }
}

// =============================================
// INIT — start page typewriter
// =============================================

window.addEventListener('load', () => {
  const startEl = document.getElementById('tw-start');
  const startChoices = document.getElementById('choices-start');
  if (startEl) {
    setTimeout(() => {
      typewriteElement(startEl, () => {
        setTimeout(() => startChoices && startChoices.classList.add('visible'), 300);
      });
    }, 800);
  }
});
</script>
</body>
</html>
